<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Reserva de Datashows</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* cinza claro de fundo */
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 2rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .tab-button.active {
            border-color: #3b82f6; /* azul */
            color: #3b82f6;
            background-color: #eff6ff; /* azul bem clarinho */
        }
        .slot.available:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .slot {
            transition: all 0.2s ease-in-out;
        }
        /* Estilo para a barra de rolagem */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div id="app" class="container mx-auto p-4 md:p-6 lg:p-8 max-w-7xl">
        <!-- Cabeçalho -->
        <header class="text-center mb-8">
            <p class="text-lg font-medium text-gray-700 mb-2">Centro de Excelência Governador Lourival Baptista</p>
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Sistema de Reserva de Datashows</h1>
            <p class="text-gray-600 mt-2">Reserve um datashow para sua aula de forma rápida e fácil.</p>
        </header>

        <!-- Abas de Navegação -->
        <div class="mb-6 flex justify-center border-b border-gray-200">
            <button id="userViewBtn" class="tab-button py-4 px-6 text-lg font-medium text-gray-500 border-b-2 border-transparent hover:text-gray-700 hover:border-gray-300 transition duration-150 ease-in-out active">
                <i class="fas fa-calendar-check mr-2"></i>Fazer Reserva
            </button>
            <button id="adminViewBtn" class="tab-button py-4 px-6 text-lg font-medium text-gray-500 border-b-2 border-transparent hover:text-gray-700 hover:border-gray-300 transition duration-150 ease-in-out">
                <i class="fas fa-user-shield mr-2"></i>Gestão
            </button>
        </div>

        <!-- Conteúdo Principal -->
        <main>
            <!-- Visão do Usuário (Reservas) -->
            <div id="userView">
                <div class="flex items-center justify-center space-x-4 mb-6">
                    <button id="prevDayBtn" class="bg-white p-2 rounded-full shadow hover:bg-gray-100 transition"><i class="fas fa-chevron-left"></i></button>
                    <h2 id="currentDate" class="text-xl font-semibold text-center"></h2>
                    <button id="nextDayBtn" class="bg-white p-2 rounded-full shadow hover:bg-gray-100 transition"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div id="scheduleGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Slots de horário serão inseridos aqui dinamicamente -->
                    <div class="text-center col-span-full py-10">
                        <i class="fas fa-spinner fa-spin fa-3x text-blue-500"></i>
                        <p class="mt-4 text-gray-600">Carregando horários...</p>
                    </div>
                </div>
            </div>

            <!-- Visão do Administrador -->
            <div id="adminView" class="hidden">
                 <div class="bg-white p-6 rounded-lg shadow-md max-w-4xl mx-auto">
                    <h2 class="text-2xl font-bold mb-4 text-center">Painel de Gestão</h2>
                    <div id="adminLogin">
                        <p class="text-center mb-4">Por favor, insira a senha de administrador para continuar.</p>
                        <div class="flex flex-col items-center">
                            <input type="password" id="adminPassword" placeholder="Senha" class="w-full max-w-sm border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <button id="adminLoginBtn" class="mt-4 bg-blue-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-600 transition">Entrar</button>
                        </div>
                    </div>
                    <div id="adminContent" class="hidden">
                        <h3 class="text-xl font-semibold mb-4">Todas as Reservas</h3>
                        <div class="overflow-x-auto">
                           <table class="min-w-full bg-white">
                               <thead class="bg-gray-50">
                                   <tr>
                                       <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                                       <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Horário</th>
                                       <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Professor(a)</th>
                                       <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Turma</th>
                                       <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ação</th>
                                   </tr>
                               </thead>
                               <tbody id="reservationsList" class="divide-y divide-gray-200">
                                   <!-- Lista de reservas será inserida aqui -->
                               </tbody>
                           </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Rodapé -->
        <footer class="text-center mt-12 pt-6 border-t border-gray-200">
            <p class="text-sm text-gray-500">
                Criado por Robison Sá. Copyright &copy; 2025. Todos os Direitos Reservados.
            </p>
        </footer>
    </div>

    <!-- Modal de Reserva -->
    <div id="reservationModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">Fazer Reserva</h3>
                <button id="closeModalBtn" class="text-2xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <p class="mb-2">Data: <span id="modalDate" class="font-semibold"></span></p>
            <p class="mb-4">Horário: <span id="modalTime" class="font-semibold"></span></p>
            <form id="reservationForm">
                <input type="hidden" id="modalDateInput">
                <input type="hidden" id="modalTimeInput">
                <div class="mb-4">
                    <label for="teacherName" class="block text-sm font-medium text-gray-700">Seu nome</label>
                    <input type="text" id="teacherName" name="teacherName" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div class="mb-6">
                    <label for="className" class="block text-sm font-medium text-gray-700">Sua Turma</label>
                    <input type="text" id="className" name="className" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancelBtn" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                    <button type="submit" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition">Confirmar Reserva</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Toast de Notificação -->
    <div id="toast" class="hidden fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg text-sm">
        <p id="toastMessage"></p>
    </div>


    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, deleteDoc, doc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- CONFIGURAÇÃO E VARIÁVEIS GLOBAIS ---
        
        // Configuração do Firebase (usando variáveis globais do ambiente)
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { /* Coloque sua config aqui para teste local */ };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-datashow-app';
        
        // Inicializa o Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Coleção principal do Firestore
        const reservationsCollection = collection(db, `artifacts/${appId}/public/data/reservations`);

        const TOTAL_PROJECTORS = 5;
        const ADMIN_PASSWORD = "gestao2025"; // Senha para o painel de gestão. MUDE ISSO!

        const schedule = [
            "1ª aula: 18:00 - 18:45",
            "2ª aula: 18:45 - 19:30",
            "Intervalo: 19:30 - 19:45",
            "3ª aula: 19:45 - 20:30",
            "4ª aula: 20:30 - 21:15",
            "5ª aula: 21:15 - 22:00",
            "6ª aula: 22:00 - 22:45"
        ];
        
        let currentDate = new Date();
        let allReservations = [];

        // --- ELEMENTOS DO DOM ---
        const userView = document.getElementById('userView');
        const adminView = document.getElementById('adminView');
        const userViewBtn = document.getElementById('userViewBtn');
        const adminViewBtn = document.getElementById('adminViewBtn');
        const scheduleGrid = document.getElementById('scheduleGrid');
        const currentDateEl = document.getElementById('currentDate');
        const prevDayBtn = document.getElementById('prevDayBtn');
        const nextDayBtn = document.getElementById('nextDayBtn');
        const modal = document.getElementById('reservationModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const reservationForm = document.getElementById('reservationForm');
        
        // --- FUNÇÕES PRINCIPAIS ---

        // Autenticação
        async function setupAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Erro na autenticação:", error);
                showToast('Falha na autenticação com o servidor.', 'error');
            }
        }
        
        // Formata a data para o padrão 'YYYY-MM-DD'
        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }
        
        // Formata a data para exibição (ex: Terça-feira, 3 de Setembro)
        function formatDisplayDate(date) {
            return date.toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }
        
        // Renderiza a grade de horários
        function renderSchedule() {
            const today = new Date();
            today.setHours(0,0,0,0);
            currentDate.setHours(0,0,0,0);
            prevDayBtn.disabled = currentDate <= today;
            prevDayBtn.classList.toggle('opacity-50', currentDate <= today);

            const dateStr = formatDate(currentDate);
            currentDateEl.textContent = formatDisplayDate(currentDate);
            scheduleGrid.innerHTML = '';
            
            schedule.forEach(timeSlot => {
                if (timeSlot.includes("Intervalo")) {
                    const slotDiv = document.createElement('div');
                    slotDiv.className = "slot bg-gray-200 rounded-lg p-4 flex items-center justify-center col-span-1 sm:col-span-2 lg:col-span-3";
                    slotDiv.innerHTML = `<p class="font-bold text-gray-600">${timeSlot}</p>`;
                    scheduleGrid.appendChild(slotDiv);
                    return;
                }
                
                const reservationsForSlot = allReservations.filter(r => r.date === dateStr && r.timeSlot === timeSlot);
                const availableCount = TOTAL_PROJECTORS - reservationsForSlot.length;
                
                const slotDiv = document.createElement('div');
                slotDiv.className = `slot rounded-lg p-4 shadow-md cursor-pointer flex flex-col justify-between h-48 ${availableCount > 0 ? 'bg-white available' : 'bg-gray-300 text-gray-500'}`;
                
                let reservedByHtml = reservationsForSlot.map(r => 
                    `<li class="text-sm truncate" title="${r.teacherName} - ${r.className}">
                        <i class="fas fa-user-check text-green-600 mr-2"></i>${r.teacherName} (${r.className})
                    </li>`
                ).join('');
                
                slotDiv.innerHTML = `
                    <div>
                        <h4 class="font-bold text-lg">${timeSlot.split(': ')[0]}</h4>
                        <p class="text-sm text-gray-600">${timeSlot.split(': ')[1]}</p>
                    </div>
                    <div class="mt-2">
                        <p class="font-semibold text-xl ${availableCount > 0 ? 'text-blue-600' : 'text-red-600'}">${availableCount} / ${TOTAL_PROJECTORS}</p>
                        <p class="text-sm">disponíveis</p>
                    </div>
                    <ul class="mt-2 space-y-1 overflow-y-auto text-gray-700" style="max-height: 60px;">${reservedByHtml}</ul>
                `;
                
                if (availableCount > 0) {
                    slotDiv.onclick = () => openModal(dateStr, timeSlot);
                } else {
                    slotDiv.classList.remove('cursor-pointer');
                }
                
                scheduleGrid.appendChild(slotDiv);
            });
        }
        
        // Abre o modal de reserva
        function openModal(date, time) {
            document.getElementById('modalDate').textContent = formatDisplayDate(new Date(date + 'T00:00:00'));
            document.getElementById('modalTime').textContent = time;
            document.getElementById('modalDateInput').value = date;
            document.getElementById('modalTimeInput').value = time;
            reservationForm.reset();
            modal.style.display = 'flex';
        }
        
        // Fecha o modal
        function closeModal() {
            modal.style.display = 'none';
        }

        // Lida com o envio do formulário de reserva
        async function handleReservationSubmit(e) {
            e.preventDefault();
            const date = document.getElementById('modalDateInput').value;
            const timeSlot = document.getElementById('modalTimeInput').value;
            const teacherName = document.getElementById('teacherName').value.trim();
            const className = document.getElementById('className').value.trim();
            
            if (!teacherName || !className) {
                showToast('Por favor, preencha todos os campos.', 'error');
                return;
            }

            // Checagem final de disponibilidade
            const reservationsForSlot = allReservations.filter(r => r.date === date && r.timeSlot === timeSlot);
            if (reservationsForSlot.length >= TOTAL_PROJECTORS) {
                showToast('Desculpe, todos os datashows para este horário foram reservados enquanto você preenchia.', 'error');
                closeModal();
                return;
            }

            try {
                await addDoc(reservationsCollection, {
                    date,
                    timeSlot,
                    teacherName,
                    className,
                    createdAt: new Date()
                });
                showToast('Reserva confirmada com sucesso!', 'success');
                closeModal();
            } catch (error) {
                console.error("Erro ao adicionar reserva: ", error);
                showToast('Ocorreu um erro ao salvar sua reserva.', 'error');
            }
        }
        
        // Exibe uma notificação (toast)
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            toast.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg text-sm ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            toast.classList.remove('hidden');
            
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        // Renderiza a lista de reservas no painel de admin
        function renderAdminList() {
            const listEl = document.getElementById('reservationsList');
            listEl.innerHTML = '';

            if (allReservations.length === 0) {
                 listEl.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">Nenhuma reserva encontrada.</td></tr>';
                 return;
            }

            allReservations.forEach(res => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="py-4 px-4">${formatDisplayDate(new Date(res.date + 'T00:00:00'))}</td>
                    <td class="py-4 px-4">${res.timeSlot}</td>
                    <td class="py-4 px-4">${res.teacherName}</td>
                    <td class="py-4 px-4">${res.className}</td>
                    <td class="py-4 px-4">
                        <button class="delete-btn text-red-500 hover:text-red-700" data-id="${res.id}">
                            <i class="fas fa-trash-alt"></i> Excluir
                        </button>
                    </td>
                `;
                listEl.appendChild(row);
            });

            // Adiciona event listeners para os botões de deletar
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const id = e.currentTarget.dataset.id;
                    // A confirmação foi removida para garantir compatibilidade. A exclusão é imediata.
                    try {
                        await deleteDoc(doc(db, `artifacts/${appId}/public/data/reservations`, id));
                        showToast('Reserva excluída com sucesso.', 'success');
                    } catch (error) {
                         console.error("Erro ao excluir reserva: ", error);
                         showToast('Ocorreu um erro ao excluir a reserva.', 'error');
                    }
                });
            });
        }
        
        // --- EVENT LISTENERS ---
        
        // Navegação de dias
        prevDayBtn.addEventListener('click', () => {
            currentDate.setDate(currentDate.getDate() - 1);
            renderSchedule();
        });
        
        nextDayBtn.addEventListener('click', () => {
            currentDate.setDate(currentDate.getDate() + 1);
            renderSchedule();
        });
        
        // Troca de abas
        userViewBtn.addEventListener('click', () => {
            userView.classList.remove('hidden');
            adminView.classList.add('hidden');
            userViewBtn.classList.add('active');
            adminViewBtn.classList.remove('active');
        });

        adminViewBtn.addEventListener('click', () => {
            userView.classList.add('hidden');
            adminView.classList.remove('hidden');
            userViewBtn.classList.remove('active');
            adminViewBtn.classList.add('active');
        });
        
        // Modal
        closeModalBtn.addEventListener('click', closeModal);
        cancelBtn.addEventListener('click', closeModal);
        window.addEventListener('click', (e) => {
            if (e.target == modal) closeModal();
        });
        reservationForm.addEventListener('submit', handleReservationSubmit);

        // Admin Login
        document.getElementById('adminLoginBtn').addEventListener('click', () => {
            const password = document.getElementById('adminPassword').value;
            if (password === ADMIN_PASSWORD) {
                document.getElementById('adminLogin').classList.add('hidden');
                document.getElementById('adminContent').classList.remove('hidden');
                renderAdminList();
            } else {
                showToast('Senha incorreta!', 'error');
            }
        });
        
        // --- INICIALIZAÇÃO ---

        async function startApp() {
            await setupAuth();
            
            // Listener em tempo real para as reservas
            // Removido o orderBy para evitar problemas de índice no Firebase. A ordenação agora é feita no navegador.
            const q = query(reservationsCollection);
            onSnapshot(q, (snapshot) => {
                allReservations = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Ordena os resultados aqui no cliente para manter a lista de admin organizada
                allReservations.sort((a, b) => {
                    const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(0);
                    const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(0);
                    return dateB - dateA;
                });

                renderSchedule();
                // Se a visão de admin estiver ativa, atualiza a lista
                if (!document.getElementById('adminContent').classList.contains('hidden')) {
                    renderAdminList();
                }
            }, (error) => {
                console.error("Erro ao buscar dados:", error);
                showToast("Não foi possível carregar os dados das reservas.", "error");
                scheduleGrid.innerHTML = '<p class="text-center col-span-full text-red-500">Erro ao conectar com o servidor. Tente recarregar a página.</p>';
            });
        }

        startApp();

    </script>
</body>
</html>